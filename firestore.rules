rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Legacy users collection - users can only access their own data
    match /users/{walletAddress} {
      allow read, write: if request.auth != null && 
        request.auth.uid == walletAddress.lower();
    }
    
    // Students collection - only parents can read/write their own students
    match /students/{studentId} {
      allow read, write: if request.auth != null && 
        resource.data.parentWallet == request.auth.uid;
    }
    
    // Authorizations - parents can create, pickup persons can read
    match /authorizations/{authId} {
      allow read: if request.auth != null && 
        (resource.data.parentWallet == request.auth.uid ||
         resource.data.pickupWallet == request.auth.uid);
      allow create: if request.auth != null && 
        request.resource.data.parentWallet == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.parentWallet == request.auth.uid;
    }
    
    // User sessions - users can only access their own sessions
    match /user-sessions/{wallet} {
      allow read, write: if request.auth != null && 
        request.auth.uid == wallet;
    }
    
    // QR codes - pickup persons can read their own, staff can read all
    match /qr-codes/{qrCodeId} {
      allow read: if request.auth != null &&
        (resource.data.pickupWallet == request.auth.uid ||
         request.auth.token.role == 'staff');
      allow create: if request.auth != null &&
        resource.data.pickupWallet == request.auth.uid;
      allow update: if request.auth != null &&
        (resource.data.pickupWallet == request.auth.uid ||
         request.auth.token.role == 'staff');
    }
    
    // Pickup logs - read-only for authorized users
    match /pickup-logs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        request.auth.token.role == 'staff';
    }
  }
}
